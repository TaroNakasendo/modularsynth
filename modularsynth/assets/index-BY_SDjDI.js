(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))t(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&t(i)}).observe(document,{childList:!0,subtree:!0});function s(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function t(n){if(n.ep)return;n.ep=!0;const o=s(n);fetch(n.href,o)}})();let C=null;function I(){if(!C){const m=window.AudioContext||window.webkitAudioContext;C=new m}return C}function A(){C&&C.state==="suspended"&&C.resume()}class v{constructor(e){this.name=e,this.context=I(),this.element=document.createElement("div"),this.element.className="module",this.element.innerHTML=`
      <div class="screw tl"></div>
      <div class="screw tr"></div>
      <div class="screw bl"></div>
      <div class="screw br"></div>
      <div class="module-header">${e}</div>
      <div class="control-row"></div>
      <div class="jack-container"></div>
    `,this.controlsContainer=this.element.querySelector(".control-row"),this.jacksContainer=this.element.querySelector(".jack-container"),this.jacks={},this.knobUpdaters={}}mount(e){e.appendChild(this.element)}addKnob(e,s,t,n,o){const i=document.createElement("div");i.className="knob-container";const a=document.createElement("div");a.className="knob";const p=document.createElement("div");p.className="label",p.innerText=e,i.appendChild(a),this.controlsContainer.appendChild(i),this.controlsContainer.appendChild(p),s&&(s.value=o);let c=!1,r=0,y=o;const f=()=>{const d=-150+(y-t)/(n-t)*300;a.style.transform=`rotate(${d}deg)`};return f(),this.knobUpdaters[e]=h=>{y=Math.max(t,Math.min(n,h)),s&&(s.value=y,s.setValueAtTime(y,this.context.currentTime)),f(),this.onKnobChange&&this.onKnobChange(e,y)},a.addEventListener("mousedown",h=>{c=!0,r=h.clientY,document.body.style.cursor="ns-resize",h.preventDefault()}),window.addEventListener("mousemove",h=>{if(!c)return;const d=r-h.clientY,l=(n-t)/200;let g=y+d*l;g=Math.max(t,Math.min(n,g)),g!==y&&(y=g,s&&s.setTargetAtTime(g,this.context.currentTime,.01),f(),this.onKnobChange&&this.onKnobChange(e,g)),r=h.clientY}),window.addEventListener("mouseup",()=>{c&&(c=!1,document.body.style.cursor="default")}),a}setKnobValue(e,s){this.knobUpdaters[e]&&this.knobUpdaters[e](s)}addJack(e,s,t){const n=document.createElement("div");n.className="jack",n.dataset.id=`${this.name}-${e}`,n.dataset.module=this.name,n.dataset.jack=e,n.dataset.type=s,n.title=e;const o=document.createElement("div");o.className="label",o.innerText=e,this.jacksContainer.appendChild(n),this.jacksContainer.appendChild(o),this.jacks[e]={type:s,target:t,element:n}}getJack(e){return this.jacks[e]}}class N extends v{constructor(){super("VCO"),this.oscillator=this.context.createOscillator(),this.oscillator.type="sawtooth",this.oscillator.frequency.value=440,this.oscillator.start(),this.addKnob("FREQ",this.oscillator.frequency,20,2e3,440),this.addKnob("DETUNE",this.oscillator.detune,-1200,1200,0),this.waveTypes=["sine","triangle","sawtooth","square"],this.currentWave=2;const e=document.createElement("div");e.className="button",e.style.marginTop="5px",e.style.marginBottom="10px",e.style.textAlign="center",e.style.cursor="pointer",e.style.fontSize="0.7rem",e.style.fontWeight="bold",e.style.color="#ff9900",e.style.background="#222",e.style.padding="5px",e.style.borderRadius="4px",e.style.border="1px solid #444",e.innerText="SAW",e.onclick=()=>{this.currentWave=(this.currentWave+1)%this.waveTypes.length;const s=this.waveTypes[this.currentWave];this.oscillator.type=s;const t={sine:"SIN",triangle:"TRI",sawtooth:"SAW",square:"SQR"};e.innerText=t[s]},this.controlsContainer.appendChild(e),this.addJack("OUT","out",this.oscillator),this.voctGain=this.context.createGain(),this.voctGain.gain.value=1200,this.voctGain.connect(this.oscillator.detune),this.addJack("V/OCT","in",{node:this.voctGain}),this.fmGain=this.context.createGain(),this.fmGain.gain.value=100,this.fmGain.connect(this.oscillator.frequency),this.addJack("FM","in",{node:this.fmGain})}}class V extends v{constructor(){super("VCA"),this.gainNode=this.context.createGain(),this.gainNode.gain.value=0,this.addKnob("GAIN",this.gainNode.gain,0,1,0),this.addJack("IN","in",{node:this.gainNode}),this.addJack("CV","in",{param:this.gainNode.gain}),this.addJack("OUT","out",this.gainNode)}}class E extends v{constructor(){super("VCF"),this.filter=this.context.createBiquadFilter(),this.filter.type="lowpass",this.filter.frequency.value=1e3,this.filter.Q.value=1,this.addKnob("FREQ",this.filter.frequency,20,2e4,1e3),this.addKnob("RES",this.filter.Q,0,20,1),this.addJack("IN","in",{node:this.filter}),this.addJack("OUT","out",this.filter),this.cvGain=this.context.createGain(),this.cvGain.gain.value=2400,this.cvGain.connect(this.filter.detune),this.addJack("CV","in",{node:this.cvGain}),this.envGain=this.context.createGain(),this.envGain.gain.value=3e3,this.envGain.connect(this.filter.detune),this.addJack("ENV","in",{node:this.envGain})}}class K extends v{constructor(){super("LFO"),this.oscillator=this.context.createOscillator(),this.oscillator.type="sine",this.oscillator.frequency.value=1,this.oscillator.start(),this.addKnob("RATE",this.oscillator.frequency,.1,20,1),this.addJack("OUT","out",this.oscillator)}}class O extends v{constructor(){super("OUTPUT"),this.masterGain=this.context.createGain(),this.masterGain.gain.value=.5,this.masterGain.connect(this.context.destination),this.addKnob("VOL",this.masterGain.gain,0,1,.5),this.addJack("IN","in",{node:this.masterGain}),this.analyser=this.context.createAnalyser(),this.analyser.fftSize=2048,this.masterGain.connect(this.analyser),this.scopeCanvas=document.createElement("canvas"),this.scopeCanvas.width=100,this.scopeCanvas.height=60,this.scopeCanvas.style.background="#0a0a0a",this.scopeCanvas.style.border="1px solid #333",this.scopeCanvas.style.marginTop="10px",this.scopeCanvas.style.borderRadius="4px",this.scopeCanvas.style.boxShadow="inset 0 0 5px rgba(0,0,0,0.8)",this.element.appendChild(this.scopeCanvas),this.scopeCtx=this.scopeCanvas.getContext("2d"),this.bufferLength=this.analyser.frequencyBinCount,this.dataArray=new Uint8Array(this.bufferLength),this.draw()}draw(){requestAnimationFrame(()=>this.draw()),this.analyser.getByteTimeDomainData(this.dataArray);const e=this.scopeCanvas.width,s=this.scopeCanvas.height;this.scopeCtx.fillStyle="rgba(0, 0, 0, 0.3)",this.scopeCtx.fillRect(0,0,e,s),this.scopeCtx.lineWidth=2,this.scopeCtx.strokeStyle="#00ff00",this.scopeCtx.beginPath();let t=0;for(let a=0;a<this.bufferLength/2;a++)if(this.dataArray[a]>128&&this.dataArray[a]<135&&this.dataArray[a+1]>128,this.dataArray[a]<=128&&this.dataArray[a+1]>128){t=a;break}const n=500,o=e/n;let i=0;for(let a=0;a<n;a++){let p=t+a;if(p>=this.bufferLength)break;const r=this.dataArray[p]/128*s/2;a===0?this.scopeCtx.moveTo(i,r):this.scopeCtx.lineTo(i,r),i+=o}this.scopeCtx.stroke()}}class w extends v{constructor(){super("KEYBOARD"),this.cvNode=this.context.createConstantSource(),this.cvNode.offset.value=0,this.cvNode.start(),this.gateNode=this.context.createConstantSource(),this.gateNode.offset.value=0,this.gateNode.start(),this.addJack("CV","out",this.cvNode),this.addJack("GATE","out",this.gateNode),this.ribbonCvNode=this.context.createConstantSource(),this.ribbonCvNode.offset.value=0,this.ribbonCvNode.start(),this.ribbonGateNode=this.context.createConstantSource(),this.ribbonGateNode.offset.value=0,this.ribbonGateNode.start(),this.ribbonGateNode.connect(this.gateNode.offset),this.addJack("RIBBON","out",this.ribbonCvNode),this.addJack("R.GATE","out",this.ribbonGateNode),this.keyMap={z:0,s:1,x:2,d:3,c:4,v:5,g:6,b:7,h:8,n:9,j:10,m:11,",":12,l:13,".":14,";":15,"/":16,q:12,2:13,w:14,3:15,e:16,r:17,5:18,t:19,6:20,y:21,7:22,u:23,i:24,9:25,o:26,0:27,p:28},this.activeKeys=[],this.physicalKeys=[],this.isLatchOn=!1,this.isArpOn=!1,this.arpRate=200,this.arpInterval=null,this.arpIndex=0,this.createButton("ARP OFF",()=>{this.isArpOn=!this.isArpOn;const o=this.element.querySelector(".arp-btn");o.innerText=this.isArpOn?"ARP ON":"ARP OFF",o.style.color=this.isArpOn?"#ff9900":"#aaa",this.isArpOn?this.startArp():(this.stopArp(),this.triggerNote())},"arp-btn"),this.createButton("HOLD OFF",()=>{this.isLatchOn=!this.isLatchOn;const o=this.element.querySelector(".hold-btn");o.innerText=this.isLatchOn?"HOLD ON":"HOLD OFF",o.style.color=this.isLatchOn?"#00ff00":"#aaa",!this.isLatchOn&&this.physicalKeys.length===0&&(this.activeKeys=[],this.isArpOn||this.triggerNote())},"hold-btn"),this.octave=0;const e=document.createElement("div");e.style.display="flex",e.style.justifyContent="space-between",e.style.width="100%",e.style.marginTop="10px";const s=(o,i)=>{const a=document.createElement("div");return a.className="button",a.innerText=o,a.style.width="45%",a.style.padding="5px",a.style.background="#444",a.style.textAlign="center",a.style.cursor="pointer",a.style.borderRadius="4px",a.style.fontSize="0.7em",a.style.userSelect="none",a.style.border="1px solid #222",a.onclick=()=>{this.octave+=i,this.octave=Math.max(-3,Math.min(3,this.octave)),this.display.innerText=`OCT: ${this.octave}`},a};e.appendChild(s("OCT -",-1)),e.appendChild(s("OCT +",1)),this.controlsContainer.appendChild(e),this.rateParam=this.context.createGain().gain,this.addKnob("RATE",this.rateParam,1,15,5),this.onKnobChange=(o,i)=>{o==="RATE"&&(this.arpRate=1e3/i,this.isArpOn&&this.restartArp())},this.initKeyboardListeners();const t=document.getElementById("virtual-keyboard");t&&this.renderVirtualKeyboard(t),this.display=document.createElement("div"),this.display.style.fontFamily="monospace",this.display.style.textAlign="center",this.display.style.marginTop="10px",this.display.style.color="var(--accent-color)",this.display.innerText="WAITING",this.element.appendChild(this.display);const n=document.createElement("div");n.style.display="flex",n.style.justifyContent="center",n.style.gap="6px",n.style.marginTop="10px",this.leds=[];for(let o=0;o<8;o++){const i=document.createElement("div");i.style.width="8px",i.style.height="8px",i.style.borderRadius="50%",i.style.background="#333",i.style.boxShadow="inset 1px 1px 2px rgba(0,0,0,0.5)",n.appendChild(i),this.leds.push(i)}this.element.appendChild(n)}createButton(e,s,t){const n=document.createElement("div");n.className="button "+(t||""),n.innerText=e,n.style.marginTop="10px",n.style.padding="5px",n.style.background="#444",n.style.textAlign="center",n.style.cursor="pointer",n.style.borderRadius="4px",n.style.fontSize="0.7em",n.style.userSelect="none",n.style.border="1px solid #222",n.addEventListener("click",s),this.controlsContainer.appendChild(n)}handleKeyDown(e){this.keyMap.hasOwnProperty(e)&&(this.isLatchOn&&this.physicalKeys.length===0&&(this.activeKeys=[],this.arpIndex=-1),this.physicalKeys.includes(e)||this.physicalKeys.push(e),this.activeKeys.includes(e)||(this.activeKeys.push(e),this.activeKeys.sort((s,t)=>this.keyMap[s]-this.keyMap[t]),this.isArpOn?this.activeKeys.length===1&&(this.arpIndex=-1):this.triggerNote()),this.updateVirtualKey(e,!0))}handleKeyUp(e){this.physicalKeys.includes(e)&&(this.physicalKeys=this.physicalKeys.filter(s=>s!==e)),this.isLatchOn||this.activeKeys.includes(e)&&(this.activeKeys=this.activeKeys.filter(s=>s!==e),this.isArpOn||this.triggerNote()),this.updateVirtualKey(e,!1)}updateVirtualKey(e,s){const t=document.querySelector(`.v-key[data-key="${e}"]`);t&&(s?t.classList.add("active"):t.classList.remove("active"))}renderVirtualKeyboard(e){e.innerHTML="";const s=[{k:"z",n:0,l:"C"},{k:"s",n:1,l:"C#"},{k:"x",n:2,l:"D"},{k:"d",n:3,l:"D#"},{k:"c",n:4,l:"E"},{k:"v",n:5,l:"F"},{k:"g",n:6,l:"F#"},{k:"b",n:7,l:"G"},{k:"h",n:8,l:"G#"},{k:"n",n:9,l:"A"},{k:"j",n:10,l:"A#"},{k:"m",n:11,l:"B"},{k:"q",n:12,l:"C"},{k:"2",n:13,l:"C#"},{k:"w",n:14,l:"D"},{k:"3",n:15,l:"D#"},{k:"e",n:16,l:"E"},{k:"r",n:17,l:"F"},{k:"5",n:18,l:"F#"},{k:"t",n:19,l:"G"},{k:"6",n:20,l:"G#"},{k:"y",n:21,l:"A"},{k:"7",n:22,l:"A#"},{k:"u",n:23,l:"B"}];s.sort((l,g)=>l.n-g.n);const t=40,n=3;let o=0;const i={};s.forEach(l=>{if(!l.l.includes("#")){const u=o*(t+n);i[l.n]=u,o++;const k=this.createKeyElement(l);k.classList.add("white"),k.style.left=`${u}px`,e.appendChild(k)}}),s.forEach(l=>{if(l.l.includes("#")){const u=this.createKeyElement(l);u.classList.add("black");const k=i[l.n-1],b=i[l.n+1];if(k!==void 0&&b!==void 0){const T=k+t+n/2-t/2;u.style.left=`${T}px`}else u.style.left="0px";e.appendChild(u)}}),e.style.width=`${o*(t+n)}px`;const a=30,p=100,c=o*(t+n),r=document.createElement("div");r.className="ribbon-controller",r.style.position="absolute",r.style.top=`${p}px`,r.style.left="0px",r.style.width=`${c}px`,r.style.height=`${a}px`,r.style.background="linear-gradient(to right, #222, #444)",r.style.boxShadow="inset 0 0 5px #000",r.style.borderRadius="4px",r.style.cursor="crosshair",r.style.touchAction="none",r.style.display="flex",r.style.overflow="hidden";const y=l=>[1,3,6,8,10].includes(l%12);for(let l=0;l<24;l++){const g=document.createElement("div");g.style.flex="1",g.style.height="100%",g.style.boxSizing="border-box",g.style.display="flex",g.style.justifyContent="center",y(l)?(g.style.alignItems="flex-start",g.style.paddingTop="5px"):(g.style.alignItems="flex-end",g.style.paddingBottom="5px");const u=document.createElement("div");u.style.borderRadius="50%",l%12===0?(u.style.width="6px",u.style.height="6px",u.style.background="#ccc",u.style.boxShadow="0 0 2px #fff"):(u.style.width="3px",u.style.height="3px",u.style.background="#555"),g.appendChild(u),r.appendChild(g)}const f=document.createElement("div");f.style.position="absolute",f.style.width="2px",f.style.height="100%",f.style.background="var(--accent-color)",f.style.display="none",f.style.pointerEvents="none",r.appendChild(f);const h=l=>{l.preventDefault();const g=r.getBoundingClientRect();let u;l.touches&&l.touches.length>0?u=l.touches[0].clientX:u=l.clientX;let k=u-g.left;k=Math.max(0,Math.min(k,g.width)),f.style.display="block",f.style.left=`${k}px`;const b=24/12,x=k/g.width*b+this.octave,T=this.context.currentTime;this.ribbonCvNode.offset.setValueAtTime(x,T),this.cvNode.offset.cancelScheduledValues(T),this.cvNode.offset.setValueAtTime(x,T)},d=l=>{this.ribbonGateNode.offset.setValueAtTime(1,this.context.currentTime),h(l);const g=()=>{this.ribbonGateNode.offset.setValueAtTime(0,this.context.currentTime),f.style.display="none",document.removeEventListener("mousemove",h),document.removeEventListener("mouseup",g),document.removeEventListener("touchmove",h),document.removeEventListener("touchend",g)};document.addEventListener("mousemove",h),document.addEventListener("mouseup",g),document.addEventListener("touchmove",h,{passive:!1}),document.addEventListener("touchend",g)};r.addEventListener("mousedown",d),r.addEventListener("touchstart",d,{passive:!1}),e.appendChild(r),e.style.height=`${p+a+10}px`,e.style.margin="15px auto"}createKeyElement(e){const s=document.createElement("div");s.className="v-key",s.dataset.key=e.k,s.innerText=e.k.toUpperCase();const t=o=>{o.preventDefault(),this.handleKeyDown(e.k)},n=o=>{o.preventDefault(),this.handleKeyUp(e.k)};return s.addEventListener("mousedown",t),s.addEventListener("mouseup",n),s.addEventListener("mouseleave",n),s.addEventListener("touchstart",t,{passive:!1}),s.addEventListener("touchend",n),s}initKeyboardListeners(){window.addEventListener("keydown",e=>{if(e.repeat)return;const s=e.key.toLowerCase();if(this.keyMap.hasOwnProperty(s)&&!e.ctrlKey&&!e.metaKey){if(document.activeElement.tagName==="INPUT")return;this.handleKeyDown(s)}}),window.addEventListener("keyup",e=>{const s=e.key.toLowerCase();this.handleKeyUp(s)})}triggerNote(){if(!this.isArpOn)if(this.activeKeys.length>0){const e=this.activeKeys[this.activeKeys.length-1],s=this.keyMap[e],t=s/12+this.octave;this.cvNode.offset.cancelScheduledValues(this.context.currentTime),this.cvNode.offset.setValueAtTime(t,this.context.currentTime),this.gateNode.offset.value===0&&this.gateNode.offset.setValueAtTime(1,this.context.currentTime),this.display.innerText=`NOTE: ${s} (${this.octave>0?"+":""}${this.octave})`}else this.gateNode.offset.cancelScheduledValues(this.context.currentTime),this.gateNode.offset.setValueAtTime(0,this.context.currentTime),this.display.innerText="OFF"}startArp(){this.arpInterval&&clearInterval(this.arpInterval),this.arpInterval=setInterval(()=>this.arpTick(),this.arpRate)}stopArp(){this.arpInterval&&clearInterval(this.arpInterval),this.arpInterval=null,this.gateNode.offset.setTargetAtTime(0,this.context.currentTime,.01),this.leds.forEach(e=>{e.style.background="#333",e.style.boxShadow="inset 1px 1px 2px rgba(0,0,0,0.5)"})}restartArp(){this.isArpOn&&this.startArp()}arpTick(){if(this.activeKeys.length===0){this.gateNode.offset.setTargetAtTime(0,this.context.currentTime,.01),this.leds.forEach(i=>{i.style.background="#333",i.style.boxShadow="inset 1px 1px 2px rgba(0,0,0,0.5)"});return}this.arpIndex=(this.arpIndex+1)%this.activeKeys.length;const e=this.arpIndex%this.leds.length;this.leds.forEach((i,a)=>{a===e?(i.style.background="#ff9900",i.style.boxShadow="0 0 8px #ff9900"):(i.style.background="#333",i.style.boxShadow="inset 1px 1px 2px rgba(0,0,0,0.5)")});const s=this.activeKeys[this.arpIndex],t=this.keyMap[s],n=t/12+this.octave,o=this.context.currentTime;this.cvNode.offset.cancelScheduledValues(o),this.cvNode.offset.setValueAtTime(n,o),this.gateNode.offset.cancelScheduledValues(o),this.gateNode.offset.setValueAtTime(1,o),this.gateNode.offset.setValueAtTime(0,o+this.arpRate/1e3*.5),this.display.innerText=`ARP: ${t} (${this.octave>0?"+":""}${this.octave})`}}class G extends v{constructor(){super("REVERB"),this.convolver=this.context.createConvolver(),this.inputNode=this.context.createGain(),this.outputNode=this.context.createGain(),this.dryGain=this.context.createGain(),this.wetGain=this.context.createGain(),this.inputNode.connect(this.dryGain),this.inputNode.connect(this.convolver),this.convolver.connect(this.wetGain),this.dryGain.connect(this.outputNode),this.wetGain.connect(this.outputNode),this.updateMix(.5),this.seconds=3,this.generateImpulse(this.seconds),this.addKnob("TIME",null,.1,5,3).onmousedown=()=>{},this.timeParam=this.context.createGain().gain,this.mixParam=this.context.createGain().gain,this.addKnob("TIME",this.timeParam,.1,10,3),this.addKnob("MIX",this.mixParam,0,1,.5),this.onKnobChange=(e,s)=>{e==="TIME"?this.generateImpulse(s):e==="MIX"&&this.updateMix(s)},this.addJack("IN","in",{node:this.inputNode}),this.addJack("OUT","out",this.outputNode)}updateMix(e){this.dryGain.gain.value=Math.cos(e*.5*Math.PI),this.wetGain.gain.value=Math.sin(e*.5*Math.PI)}generateImpulse(e){const s=this.context.sampleRate,t=s*e,n=this.context.createBuffer(2,t,s),o=n.getChannelData(0),i=n.getChannelData(1);for(let a=0;a<t;a++){const p=Math.pow(1-a/t,2);o[a]=(Math.random()*2-1)*p,i[a]=(Math.random()*2-1)*p}this.convolver.buffer=n}}class R extends v{constructor(){super("MANUAL"),this.element.style.width="450px",this.element.style.overflowY="auto",this.element.style.background="#222";const e=document.createElement("div");e.style.padding="0 10px",e.style.fontSize="0.75rem",e.style.color="#ccc",e.style.lineHeight="1.4",e.style.textAlign="left",e.innerHTML=`
      <h3>Modular Synth Guide</h3>
      <p>Web Audio Modular Synthesizerへようこそ。</p>
      
      <h4>基本操作</h4>
      <ul>
        <li><strong>パッチ接続:</strong> OUTジャックからINジャックへドラッグ＆ドロップ。</li>
        <li><strong>切断:</strong> ジャックをクリックすると接続が解除されます。</li>
        <li><strong>ノブ操作:</strong> 上下にドラッグして値を調整します。</li>
        <li><strong>プリセット:</strong> 上部ボタンでGun, Organ, Dub Sirenなどを切り替え。</li>
      </ul>
      
      <h4>モジュール解説</h4>
      <ul>
        <li><strong>Keyboard:</strong> 演奏入力モジュール。
          <ul>
            <li>KEY: PCキーボード (Z,S,X...下段, Q,2,W...上段) 対応。</li>
            <li>ARP: アルペジエーター。押した和音を分散して再生。</li>
            <li>HOLD: 鍵盤を離しても音を持続。</li>
            <li>OCT +/-: オクターブ変更 (-3 ～ +3)。</li>
          </ul>
        </li>
        <li><strong>Sequencer:</strong> 8ステップシーケンサー。スライダーで音程設定。</li>
        <li><strong>VCO:</strong> オシレーター。音の発生源。V/OCT入力で音程制御。</li>
        <li><strong>LFO:</strong> 低周波オシレーター。ビブラートや変調に使用。</li>
        <li><strong>Noise:</strong> ホワイト/ピンクノイズ。</li>
        <li><strong>ADSR:</strong> エンベロープジェネレーター。
          <ul>
            <li>A (Attack): 音の立ち上がり時間。</li>
            <li>D (Decay): 最大音量からSustainレベルに下がるまでの時間。</li>
            <li>S (Sustain): 鍵盤を押している間の音量レベル。</li>
            <li>R (Release): 鍵盤を離した後の余韻時間。</li>
          </ul>
        </li>
        <li><strong>VCF:</strong> フィルター。音の明るさを削る。ENV入力でワウ効果。</li>
        <li><strong>VCA:</strong> アンプ。音量を制御。GATEやADSRで開閉する。</li>
        <li><strong>Delay / Reverb:</strong> 空間系エフェクト。</li>
        <li><strong>Vocoder:</strong> ボコーダー。マイク入力でシンセを喋らせる。</li>
      </ul>

      <h4>ジャック解説 (Jacks)</h4>
      <ul>
        <li><strong>CV / V/OCT:</strong> 音程制御電圧。1V = 1オクターブ。</li>
        <li><strong>GATE:</strong> 発音信号。押している間ON。</li>
        <li><strong>ENV:</strong> エンベロープ入力。フィルターやピッチを時間変化させる。</li>
        <li><strong>FM:</strong> 周波数変調。ビブラートなど。</li>
      </ul>
      
      <p style="text-align: center; margin-top: 20px; color: #666; font-size: 0.8rem;">
        Created with Web Audio API
      </p>
    `,this.controlsContainer.style.display="none",this.jacksContainer.style.display="none",this.element.appendChild(e)}}class S extends v{constructor(){super("SEQ-8"),this.steps=[0,0,0,0,0,0,0,0],this.currentStep=0,this.isRunning=!0,this.tempo=300,this.timer=null,this.cvOut=this.context.createConstantSource(),this.cvOut.offset.value=0,this.cvOut.start(),this.gateOut=this.context.createConstantSource(),this.gateOut.offset.value=0,this.gateOut.start(),this.controlsContainer.style.flexDirection="row",this.controlsContainer.style.flexWrap="wrap",this.controlsContainer.style.justifyContent="space-around";const e=document.createElement("div");e.style.width="100%",e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="center",e.style.marginBottom="10px",e.style.borderBottom="1px solid #444",e.style.paddingBottom="5px",this.controlsContainer.appendChild(e);const s=this.controlsContainer;this.controlsContainer=e,this.addKnob("RATE",null,50,1e3,300),this.controlsContainer=s,this.stepKnobs=[],this.leds=[];for(let n=0;n<8;n++){const o=document.createElement("div");o.style.display="flex",o.style.flexDirection="column",o.style.alignItems="center",o.style.width="45%",o.style.marginBottom="5px";const i=document.createElement("div");i.style.width="8px",i.style.height="8px",i.style.borderRadius="50%",i.style.background="#333",i.style.marginBottom="2px",o.appendChild(i),this.leds.push(i);const a=document.createElement("input");a.type="range",a.min=0,a.max=24,a.value=this.steps[n],a.step=1,a.style.width="100%",a.style.height="10px",a.className="seq-slider",a.addEventListener("input",c=>{this.steps[n]=parseInt(c.target.value)}),this.stepKnobs.push(a);const p=document.createElement("div");p.innerText=n+1,p.className="label",o.appendChild(a),o.appendChild(p),this.controlsContainer.appendChild(o)}const t=document.createElement("button");t.innerText="STOP",t.style.width="100%",t.style.marginTop="5px",t.style.fontSize="0.7rem",t.style.background="#550000",t.onclick=()=>{this.isRunning=!this.isRunning,t.innerText=this.isRunning?"STOP":"RUN",t.style.background=this.isRunning?"#550000":"#005500"},this.controlsContainer.appendChild(t),this.onKnobChange=(n,o)=>{n==="RATE"&&(this.tempo=o,this.restart())},this.addJack("CV","out",this.cvOut),this.addJack("GATE","out",this.gateOut),this.start()}start(){this.timer&&clearInterval(this.timer),this.timer=setInterval(()=>this.tick(),this.tempo)}restart(){this.start()}setSteps(e){e.length===8&&(this.steps=[...e],this.stepKnobs.forEach((s,t)=>{s.value=this.steps[t]}))}tick(){if(!this.isRunning||this.context.state==="suspended")return;this.leds.forEach((o,i)=>{o.style.background=i===this.currentStep?"#ff0000":"#333",o.style.boxShadow=i===this.currentStep?"0 0 5px #ff0000":"none"});const s=this.steps[this.currentStep]/12,t=this.context.currentTime;this.cvOut.offset.setValueAtTime(s,t);const n=this.tempo/1e3*.5;this.gateOut.offset.cancelScheduledValues(t),this.gateOut.offset.setValueAtTime(1,t),this.gateOut.offset.setValueAtTime(0,t+n),this.currentStep=(this.currentStep+1)%8,this.timer&&(clearInterval(this.timer),this.timer=setInterval(()=>this.tick(),this.tempo))}}class D extends v{constructor(){super("NOISE");const e=2*this.context.sampleRate;this.whiteBuffer=this.context.createBuffer(1,e,this.context.sampleRate);const s=this.whiteBuffer.getChannelData(0);for(let y=0;y<e;y++)s[y]=Math.random()*2-1;this.pinkBuffer=this.context.createBuffer(1,e,this.context.sampleRate);const t=this.pinkBuffer.getChannelData(0);let n=0,o=0,i=0,a=0,p=0,c=0,r=0;for(let y=0;y<e;y++){const f=Math.random()*2-1;n=.99886*n+f*.0555179,o=.99332*o+f*.0750759,i=.969*i+f*.153852,a=.8665*a+f*.3104856,p=.55*p+f*.5329522,c=-.7616*c-f*.016898,t[y]=n+o+i+a+p+c+r+f*.5362,t[y]*=.11,r=f*.115926}this.isPink=!1,this.source=null,this.outputGain=this.context.createGain(),this.startSource(),this.typeBtn=document.createElement("div"),this.typeBtn.className="button",this.typeBtn.style.marginTop="15px",this.typeBtn.style.marginBottom="15px",this.typeBtn.style.textAlign="center",this.typeBtn.style.cursor="pointer",this.typeBtn.style.fontSize="0.8rem",this.typeBtn.style.fontWeight="bold",this.typeBtn.style.color="#fff",this.typeBtn.style.background="#333",this.typeBtn.style.padding="8px",this.typeBtn.style.borderRadius="4px",this.typeBtn.style.border="1px solid #555",this.typeBtn.innerText="WHITE",this.typeBtn.onclick=()=>{this.setNoiseType(!this.isPink)},this.controlsContainer.appendChild(this.typeBtn),this.addJack("OUT","out",this.outputGain)}setNoiseType(e){this.isPink=e,this.typeBtn.innerText=this.isPink?"PINK":"WHITE",this.typeBtn.style.color=this.isPink?"#ffaddb":"#ffffff",this.startSource()}startSource(){this.source&&(this.source.stop(),this.source.disconnect()),this.source=this.context.createBufferSource(),this.source.buffer=this.isPink?this.pinkBuffer:this.whiteBuffer,this.source.loop=!0,this.source.start(),this.source.connect(this.outputGain)}}class B extends v{constructor(){super("ADSR"),this.attack=.01,this.decay=.1,this.sustain=.5,this.release=.3,this.envNode=this.context.createConstantSource(),this.envNode.offset.value=0,this.envNode.start(),this.gateInput=this.context.createGain(),this.gateInput.gain.value=1;try{this.processor=new AudioWorkletNode(this.context,"gate-processor"),this.processor.port.onmessage=s=>{s.data==="trigger"&&this.triggerAttack(),s.data==="release"&&this.triggerRelease()},this.gateInput.connect(this.processor),this.processor.connect(this.context.destination)}catch{console.warn("AudioWorklet 'gate-processor' not found, falling back to ScriptProcessor. Warning: ScriptProcessor is deprecated."),this.processor=this.context.createScriptProcessor(256,1,1),this.gateInput.connect(this.processor),this.processor.connect(this.context.destination),this.lastGate=0,this.processor.onaudioprocess=t=>{const n=t.inputBuffer.getChannelData(0);let o=0;for(let i=0;i<n.length;i++)if(n[i]>.5){o=1;break}o===1&&this.lastGate===0?this.triggerAttack():o===0&&this.lastGate===1&&this.triggerRelease(),this.lastGate=o}}this.led=document.createElement("div"),this.led.style.width="10px",this.led.style.height="10px",this.led.style.borderRadius="50%",this.led.style.background="#333",this.led.style.margin="10px auto",this.led.style.boxShadow="inset 1px 1px 2px rgba(0,0,0,0.5)",this.controlsContainer.appendChild(this.led);const e=document.createElement("button");e.innerText="MANUAL",e.style.fontSize="0.7rem",e.style.width="100%",e.style.marginTop="5px",e.onclick=()=>{this.triggerAttack(),setTimeout(()=>this.triggerRelease(),200)},this.controlsContainer.appendChild(e),this.addKnob("A",null,.001,2,.01),this.addKnob("D",null,.001,2,.1),this.addKnob("S",null,0,1,.5),this.addKnob("R",null,.001,5,.3),this.onKnobChange=(s,t)=>{s==="A"&&(this.attack=t),s==="D"&&(this.decay=t),s==="S"&&(this.sustain=t),s==="R"&&(this.release=t)},this.addJack("GATE","in",this.gateInput),this.addJack("OUT","out",this.envNode)}triggerAttack(){const e=this.context.currentTime,s=this.envNode.offset;try{s.cancelAndHoldAtTime(e)}catch{s.cancelScheduledValues(e)}s.linearRampToValueAtTime(1,e+this.attack),s.linearRampToValueAtTime(this.sustain,e+this.attack+this.decay),this.led.style.background="#ff0000",this.led.style.boxShadow="0 0 10px #ff0000"}triggerRelease(){const e=this.context.currentTime,s=this.envNode.offset;try{s.cancelAndHoldAtTime(e)}catch{s.cancelScheduledValues(e)}s.linearRampToValueAtTime(0,e+this.release),this.led.style.background="#333",this.led.style.boxShadow="inset 1px 1px 2px rgba(0,0,0,0.5)"}}class U extends v{constructor(){super("DELAY"),this.input=this.context.createGain(),this.output=this.context.createGain(),this.delayNode=this.context.createDelay(5),this.feedbackGain=this.context.createGain(),this.mixNode=this.context.createGain(),this.dryNode=this.context.createGain(),this.delayNode.delayTime.value=.3,this.feedbackGain.gain.value=.4,this.setMix(.5),this.input.connect(this.dryNode),this.dryNode.connect(this.output),this.input.connect(this.delayNode),this.delayNode.connect(this.mixNode),this.mixNode.connect(this.output),this.delayNode.connect(this.feedbackGain),this.feedbackGain.connect(this.delayNode),this.addKnob("TIME",this.delayNode.delayTime,.01,1,.3),this.addKnob("FB",this.feedbackGain.gain,0,.95,.4),this.mixVal=.5,this.addKnob("MIX",null,0,1,.5),this.onKnobChange=(e,s)=>{e==="MIX"&&this.setMix(s)},this.addJack("IN","in",this.input),this.addJack("OUT","out",this.output)}setMix(e){this.dryNode.gain.value=1-e,this.mixNode.gain.value=e}}class M extends v{constructor(){super("VOCODER"),this.bands=20,this.detectors=[],this.filters=[],this.vcas=[],this.carrierFilters=[],this.modulatorInput=this.context.createGain(),this.carrierInput=this.context.createGain(),this.outputNode=this.context.createGain(),this.micStream=null,this.micSource=null,this.setupBands(this.bands),this.micBtn=document.createElement("div"),this.micBtn.className="button",this.micBtn.style.marginTop="10px",this.micBtn.style.textAlign="center",this.micBtn.style.cursor="pointer",this.micBtn.style.fontSize="0.7rem",this.micBtn.style.fontWeight="bold",this.micBtn.style.color="#fff",this.micBtn.style.background="#444",this.micBtn.style.padding="5px",this.micBtn.style.borderRadius="4px",this.micBtn.style.border="1px solid #666",this.micBtn.innerText="MIC: OFF",this.micBtn.onclick=()=>this.toggleMic(),this.controlsContainer.appendChild(this.micBtn),this.modulatorInput.gain.value=1,this.addKnob("SENS",this.modulatorInput.gain,0,5,1),this.addJack("CARRIER","in",{node:this.carrierInput}),this.addJack("MOD","in",{node:this.modulatorInput}),this.addJack("OUT","out",this.outputNode)}setupBands(e){const n=Math.pow(240,1/e);for(let o=0;o<e;o++){const i=50*Math.pow(n,o),a=this.context.createBiquadFilter();a.type="bandpass",a.frequency.value=i,a.Q.value=10,this.modulatorInput.connect(a);const p=this.context.createWaveShaper();p.curve=this.makeAbsCurve();const c=this.context.createBiquadFilter();c.type="lowpass",c.frequency.value=80,a.connect(p),p.connect(c);const r=this.context.createBiquadFilter();r.type="bandpass",r.frequency.value=i,r.Q.value=10,this.carrierInput.connect(r);const y=this.context.createGain();y.gain.value=0,r.connect(y),y.connect(this.outputNode);const f=this.context.createGain();f.gain.value=100,c.connect(f),f.connect(y.gain),this.filters.push({analyzer:a,sourceFilter:r,smoother:c,vca:y,rectifier:p,gainBooster:f})}}makeAbsCurve(){const e=new Float32Array(65536);for(let s=0;s<65536;s++){const t=s/65536*2-1;e[s]=Math.abs(t)}return e}async toggleMic(){if(this.micStream)this.micStream.getTracks().forEach(e=>e.stop()),this.micStream=null,this.micSource&&this.micSource.disconnect(),this.micBtn.innerText="MIC: OFF",this.micBtn.style.background="#444",this.micBtn.style.color="#fff";else try{this.micStream=await navigator.mediaDevices.getUserMedia({audio:!0}),this.micSource=this.context.createMediaStreamSource(this.micStream),this.micSource.connect(this.modulatorInput),this.micBtn.innerText="MIC: ON",this.micBtn.style.background="#f00",this.micBtn.style.color="#fff"}catch(e){console.error("Mic Access Denied",e),this.micBtn.innerText="ERR",alert("Microphone access denied or not available.")}}}class F{constructor(e,s){this.canvas=e,this.ctx=e.getContext("2d"),this.audioCtx=s,this.cables=[],this.activeDrag=null,this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas()),this.render()}resizeCanvas(){this.canvas.parentElement&&(this.canvas.width=this.canvas.parentElement.scrollWidth,this.canvas.height=this.canvas.parentElement.scrollHeight,this.canvas.style.width=`${this.canvas.parentElement.scrollWidth}px`,this.canvas.style.height=`${this.canvas.parentElement.scrollHeight}px`)}getJackPosition(e){const s=e.getBoundingClientRect(),t=this.canvas.getBoundingClientRect();return{x:s.left-t.left+s.width/2,y:s.top-t.top+s.height/2}}startDrag(e,s,t){this.activeDrag={startJack:e,currentPos:this.getJackPosition(e.element),startPointer:{x:s,y:t}}}updateDrag(e,s){const t=this.canvas.getBoundingClientRect();this.activeDrag.currentPos={x:e-t.left,y:s-t.top}}endDrag(e,s,t){if(!this.activeDrag)return;const n=this.activeDrag.startJack,o=Math.sqrt(Math.pow(s-this.activeDrag.startPointer.x,2)+Math.pow(t-this.activeDrag.startPointer.y,2));o<5&&e===n?this.disconnectAll(n):o<5?this.disconnectAll(n):e&&n.type!==e.type&&n.element!==e.element&&this.connect(n,e),this.activeDrag=null}connect(e,s){let t=e.type==="out"?e:s,n=e.type==="in"?e:s;if(t.type!=="out"||n.type!=="in"||this.cables.find(c=>c.outDesc.element===t.element&&c.inDesc.element===n.element))return;const i=t.target.node||t.target,a=n.target.param,p=n.target.node||n.target;try{if(a)i.connect(a);else if(p)i.connect(p);else{console.error("Invalid connection destination",n);return}}catch(c){console.error("Connection failed",c);return}this.cables.push({outDesc:t,inDesc:n,color:`hsl(${Math.random()*360}, 70%, 50%)`}),t.element.classList.add("connected"),n.element.classList.add("connected")}disconnectAll(e){const s=this.cables.filter(t=>t.outDesc.element===e.element||t.inDesc.element===e.element);s.forEach(t=>{try{const n=t.outDesc.target.node||t.outDesc.target,o=t.inDesc.target.param||t.inDesc.target.node||t.inDesc.target;n.disconnect(o)}catch(n){console.warn("Disconnect error",n)}}),this.cables=this.cables.filter(t=>!s.includes(t)),document.querySelectorAll(".jack.connected").forEach(t=>t.classList.remove("connected")),this.cables.forEach(t=>{t.outDesc.element.classList.add("connected"),t.inDesc.element.classList.add("connected")})}clearAllPatches(){[...this.cables].forEach(e=>{try{const s=e.outDesc.target.node||e.outDesc.target,t=e.inDesc.target.param||e.inDesc.target.node||e.inDesc.target;s.disconnect(t)}catch(s){console.warn("Disconnect error",s)}}),this.cables=[],document.querySelectorAll(".jack.connected").forEach(e=>e.classList.remove("connected"))}render(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.lineWidth=4,this.ctx.lineCap="round";for(const e of this.cables){const s=this.getJackPosition(e.outDesc.element),t=this.getJackPosition(e.inDesc.element);this.drawCable(s,t,e.color)}if(this.activeDrag){const e=this.getJackPosition(this.activeDrag.startJack.element),s=this.activeDrag.currentPos;this.drawCable(e,s,"#fff")}requestAnimationFrame(()=>this.render())}drawCable(e,s,t){this.ctx.strokeStyle=t,this.ctx.shadowBlur=5,this.ctx.shadowColor=t,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y);const n=Math.sqrt(Math.pow(s.x-e.x,2)+Math.pow(s.y-e.y,2)),o=Math.min(n*.5,300),i={x:e.x,y:e.y+o},a={x:s.x,y:s.y+o};this.ctx.bezierCurveTo(i.x,i.y,a.x,a.y,s.x,s.y),this.ctx.stroke()}}const L="data:text/javascript;base64,Y2xhc3MgR2F0ZVByb2Nlc3NvciBleHRlbmRzIEF1ZGlvV29ya2xldFByb2Nlc3NvciB7DQogIGNvbnN0cnVjdG9yKCkgew0KICAgIHN1cGVyKCk7DQogICAgdGhpcy5sYXN0R2F0ZSA9IDA7DQogIH0NCg0KICBwcm9jZXNzKGlucHV0cywgb3V0cHV0cywgcGFyYW1ldGVycykgew0KICAgIGNvbnN0IGlucHV0ID0gaW5wdXRzWzBdOw0KICAgIGlmIChpbnB1dCAmJiBpbnB1dC5sZW5ndGggPiAwKSB7DQogICAgICBjb25zdCBjaGFubmVsRGF0YSA9IGlucHV0WzBdOw0KICAgICAgDQogICAgICAvLyBDaGVjayBidWZmZXIgZm9yIGdhdGUgc2lnbmFsDQogICAgICBsZXQgY3VycmVudEdhdGUgPSAwOw0KICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGFubmVsRGF0YS5sZW5ndGg7IGkrKykgew0KICAgICAgICBpZiAoY2hhbm5lbERhdGFbaV0gPiAwLjUpIHsNCiAgICAgICAgICBjdXJyZW50R2F0ZSA9IDE7DQogICAgICAgICAgYnJlYWs7DQogICAgICAgIH0NCiAgICAgIH0NCg0KICAgICAgaWYgKGN1cnJlbnRHYXRlID09PSAxICYmIHRoaXMubGFzdEdhdGUgPT09IDApIHsNCiAgICAgICAgdGhpcy5wb3J0LnBvc3RNZXNzYWdlKCd0cmlnZ2VyJyk7DQogICAgICB9IGVsc2UgaWYgKGN1cnJlbnRHYXRlID09PSAwICYmIHRoaXMubGFzdEdhdGUgPT09IDEpIHsNCiAgICAgICAgdGhpcy5wb3J0LnBvc3RNZXNzYWdlKCdyZWxlYXNlJyk7DQogICAgICB9DQogICAgICANCiAgICAgIHRoaXMubGFzdEdhdGUgPSBjdXJyZW50R2F0ZTsNCiAgICB9DQogICAgDQogICAgcmV0dXJuIHRydWU7DQogIH0NCn0NCg0KcmVnaXN0ZXJQcm9jZXNzb3IoJ2dhdGUtcHJvY2Vzc29yJywgR2F0ZVByb2Nlc3Nvcik7DQo=",P=async()=>{const m=document.getElementById("rack"),e=document.getElementById("cable-canvas"),s=I();try{await s.audioWorklet.addModule(L)}catch(i){console.warn("AudioWorklet load failed, fallback might be needed",i)}const t=new F(e,s),n=[new w,new S,new N,new N,new K,new D,new B,new E,new V,new U,new G,new M,new O,new R];n.forEach(i=>i.mount(m)),t.resizeCanvas(),document.addEventListener("mousedown",i=>{if(i.target.classList.contains("jack")){const a=i.target.dataset.module,p=i.target.dataset.jack,c=n.find(r=>r.name===a&&r.getJack(p).element===i.target);if(c){const r=c.getJack(p);t.startDrag(r,i.clientX,i.clientY),i.preventDefault()}}}),document.addEventListener("mousemove",i=>{t.activeDrag&&t.updateDrag(i.clientX,i.clientY)}),document.addEventListener("mouseup",i=>{if(t.activeDrag){let a=null;const p=document.elementFromPoint(i.clientX,i.clientY);if(p&&p.classList.contains("jack")){const c=p.dataset.jack;for(const r of n){const y=r.getJack(c);if(y&&y.element===p){a=y;break}}}t.endDrag(a,i.clientX,i.clientY)}});const o=i=>{t.clearAllPatches();const a=n[0],p=n[1],c=n[2],r=n[3],y=n[4],f=n[5],h=n[6],d=n[7],l=n[8],g=n[9],u=n[10],k=n[11],b=n[12];[c,r].forEach(x=>{x.setKnobValue("FREQ",440),x.setKnobValue("DETUNE",0),x.oscillator.type="sawtooth"}),y.setKnobValue("RATE",1),y.oscillator.type="sine",d.setKnobValue("FREQ",2e3),d.setKnobValue("RES",1),l.setKnobValue("GAIN",0),h.setKnobValue("A",.01),h.setKnobValue("D",.1),h.setKnobValue("S",.5),h.setKnobValue("R",.3),g.setKnobValue("MIX",0),g.setKnobValue("TIME",.3),g.setKnobValue("FB",0),u.setKnobValue("MIX",0),f.setNoiseType(!1);try{i==="default"?(t.connect(a.getJack("CV"),c.getJack("V/OCT")),t.connect(a.getJack("CV"),r.getJack("V/OCT")),r.setKnobValue("DETUNE",10),t.connect(c.getJack("OUT"),d.getJack("IN")),t.connect(r.getJack("OUT"),d.getJack("IN")),t.connect(d.getJack("OUT"),l.getJack("IN")),t.connect(l.getJack("OUT"),u.getJack("IN")),t.connect(u.getJack("OUT"),b.getJack("IN")),t.connect(a.getJack("GATE"),l.getJack("CV")),u.setKnobValue("MIX",.2)):i==="bass"?(c.oscillator.type="square",r.oscillator.type="sawtooth",r.setKnobValue("DETUNE",-1200),t.connect(a.getJack("CV"),c.getJack("V/OCT")),t.connect(a.getJack("CV"),r.getJack("V/OCT")),t.connect(c.getJack("OUT"),d.getJack("IN")),t.connect(r.getJack("OUT"),d.getJack("IN")),t.connect(d.getJack("OUT"),l.getJack("IN")),t.connect(l.getJack("OUT"),b.getJack("IN")),t.connect(a.getJack("GATE"),l.getJack("CV")),d.setKnobValue("FREQ",600)):i==="scifi"?(t.connect(y.getJack("OUT"),c.getJack("V/OCT")),t.connect(c.getJack("OUT"),u.getJack("IN")),t.connect(u.getJack("OUT"),b.getJack("IN")),u.setKnobValue("MIX",.5),y.setKnobValue("RATE",.5)):i==="sequencer"?(t.connect(p.getJack("CV"),c.getJack("V/OCT")),t.connect(p.getJack("GATE"),h.getJack("GATE")),t.connect(c.getJack("OUT"),d.getJack("IN")),t.connect(d.getJack("OUT"),l.getJack("IN")),t.connect(l.getJack("OUT"),g.getJack("IN")),t.connect(g.getJack("OUT"),b.getJack("IN")),t.connect(h.getJack("OUT"),l.getJack("CV")),t.connect(h.getJack("OUT"),d.getJack("ENV")),c.oscillator.type="sawtooth",c.setKnobValue("DETUNE",0),h.setKnobValue("A",.01),h.setKnobValue("D",.2),h.setKnobValue("S",0),h.setKnobValue("R",.2),d.setKnobValue("FREQ",400),d.setKnobValue("RES",8),g.setKnobValue("MIX",.4),g.setKnobValue("TIME",.3),g.setKnobValue("FB",.4),p.setKnobValue("RATE",200),p.setSteps([0,12,3,7,0,10,5,12]),p.isRunning||p.start()):i==="wind"?(f.setNoiseType(!0),t.connect(f.getJack("OUT"),d.getJack("IN")),t.connect(y.getJack("OUT"),d.getJack("CV")),t.connect(d.getJack("OUT"),l.getJack("IN")),t.connect(l.getJack("OUT"),u.getJack("IN")),t.connect(u.getJack("OUT"),b.getJack("IN")),y.setKnobValue("RATE",.2),d.setKnobValue("FREQ",600),d.setKnobValue("RES",20),l.setKnobValue("GAIN",.7),u.setKnobValue("TIME",5),u.setKnobValue("MIX",.6)):i==="vocoder"?(c.oscillator.type="sawtooth",r.oscillator.type="sawtooth",c.setKnobValue("FREQ",110),r.setKnobValue("FREQ",112),c.setKnobValue("DETUNE",0),r.setKnobValue("DETUNE",0),t.connect(a.getJack("CV"),c.getJack("V/OCT")),t.connect(a.getJack("CV"),r.getJack("V/OCT")),t.connect(c.getJack("OUT"),k.getJack("CARRIER")),t.connect(r.getJack("OUT"),k.getJack("CARRIER")),t.connect(k.getJack("OUT"),b.getJack("IN")),k.micStream||k.toggleMic()):i==="lead"?(c.oscillator.type="sawtooth",r.oscillator.type="square",r.setKnobValue("DETUNE",5),t.connect(a.getJack("CV"),c.getJack("V/OCT")),t.connect(a.getJack("CV"),r.getJack("V/OCT")),t.connect(c.getJack("OUT"),d.getJack("IN")),t.connect(r.getJack("OUT"),d.getJack("IN")),t.connect(d.getJack("OUT"),l.getJack("IN")),t.connect(l.getJack("OUT"),g.getJack("IN")),t.connect(g.getJack("OUT"),u.getJack("IN")),t.connect(u.getJack("OUT"),b.getJack("IN")),t.connect(a.getJack("GATE"),h.getJack("GATE")),t.connect(h.getJack("OUT"),l.getJack("CV")),t.connect(h.getJack("OUT"),d.getJack("ENV")),h.setKnobValue("A",.05),h.setKnobValue("D",.3),h.setKnobValue("S",.4),h.setKnobValue("R",.5),d.setKnobValue("FREQ",800),d.setKnobValue("RES",5),g.setKnobValue("MIX",.3),g.setKnobValue("TIME",.4),u.setKnobValue("MIX",.3)):i==="helicopter"?(f.setNoiseType(!1),t.connect(f.getJack("OUT"),d.getJack("IN")),t.connect(d.getJack("OUT"),l.getJack("IN")),t.connect(l.getJack("OUT"),u.getJack("IN")),t.connect(u.getJack("OUT"),b.getJack("IN")),t.connect(y.getJack("OUT"),d.getJack("CV")),t.connect(y.getJack("OUT"),l.getJack("CV")),y.oscillator.type="sawtooth",y.setKnobValue("RATE",6),d.setKnobValue("FREQ",200),d.setKnobValue("RES",5),l.setKnobValue("GAIN",.5),u.setKnobValue("MIX",.1)):i==="siren"?(c.oscillator.type="sine",t.connect(c.getJack("OUT"),l.getJack("IN")),t.connect(l.getJack("OUT"),g.getJack("IN")),t.connect(g.getJack("OUT"),b.getJack("IN")),t.connect(y.getJack("OUT"),c.getJack("V/OCT")),t.connect(y.getJack("OUT"),l.getJack("CV")),y.oscillator.type="triangle",y.setKnobValue("RATE",1),l.setKnobValue("GAIN",1),c.setKnobValue("FREQ",600),g.setKnobValue("MIX",.4),g.setKnobValue("TIME",.25),g.setKnobValue("FB",.7)):i==="kick"?(c.oscillator.type="sine",c.setKnobValue("FREQ",50),t.connect(c.getJack("OUT"),l.getJack("IN")),t.connect(l.getJack("OUT"),b.getJack("IN")),t.connect(a.getJack("GATE"),h.getJack("GATE")),t.connect(h.getJack("OUT"),l.getJack("CV")),t.connect(h.getJack("OUT"),c.getJack("V/OCT")),h.setKnobValue("A",.001),h.setKnobValue("D",.2),h.setKnobValue("S",0),h.setKnobValue("R",.1)):i==="gun"?(f.setNoiseType(!0),c.oscillator.type="sawtooth",c.setKnobValue("FREQ",150),t.connect(f.getJack("OUT"),d.getJack("IN")),t.connect(c.getJack("OUT"),d.getJack("IN")),t.connect(d.getJack("OUT"),l.getJack("IN")),t.connect(l.getJack("OUT"),u.getJack("IN")),t.connect(u.getJack("OUT"),b.getJack("IN")),t.connect(a.getJack("GATE"),h.getJack("GATE")),t.connect(h.getJack("OUT"),l.getJack("CV")),t.connect(h.getJack("OUT"),d.getJack("ENV")),t.connect(h.getJack("OUT"),c.getJack("V/OCT")),h.setKnobValue("A",.001),h.setKnobValue("D",.15),h.setKnobValue("S",0),h.setKnobValue("R",.2),d.setKnobValue("FREQ",2e3),u.setKnobValue("MIX",.4),u.setKnobValue("TIME",2)):i==="organ"?(c.oscillator.type="sawtooth",r.oscillator.type="sawtooth",r.setKnobValue("DETUNE",1200),c.setKnobValue("DETUNE",5),t.connect(c.getJack("OUT"),d.getJack("IN")),t.connect(r.getJack("OUT"),d.getJack("IN")),t.connect(d.getJack("OUT"),l.getJack("IN")),t.connect(l.getJack("OUT"),u.getJack("IN")),t.connect(u.getJack("OUT"),b.getJack("IN")),t.connect(a.getJack("CV"),c.getJack("V/OCT")),t.connect(a.getJack("CV"),r.getJack("V/OCT")),t.connect(a.getJack("GATE"),h.getJack("GATE")),t.connect(h.getJack("OUT"),l.getJack("CV")),h.setKnobValue("A",.05),h.setKnobValue("D",0),h.setKnobValue("S",1),h.setKnobValue("R",.1),d.setKnobValue("FREQ",1500),d.setKnobValue("RES",1),u.setKnobValue("MIX",.5),u.setKnobValue("TIME",3)):i==="piano"&&(c.oscillator.type="sawtooth",r.oscillator.type="square",r.setKnobValue("DETUNE",5),t.connect(c.getJack("OUT"),d.getJack("IN")),t.connect(r.getJack("OUT"),d.getJack("IN")),t.connect(d.getJack("OUT"),l.getJack("IN")),t.connect(l.getJack("OUT"),u.getJack("IN")),t.connect(u.getJack("OUT"),b.getJack("IN")),t.connect(a.getJack("CV"),c.getJack("V/OCT")),t.connect(a.getJack("CV"),r.getJack("V/OCT")),t.connect(a.getJack("GATE"),h.getJack("GATE")),t.connect(h.getJack("OUT"),l.getJack("CV")),t.connect(h.getJack("OUT"),d.getJack("ENV")),h.setKnobValue("A",.01),h.setKnobValue("D",.6),h.setKnobValue("S",0),h.setKnobValue("R",.4),d.setKnobValue("FREQ",600),d.setKnobValue("RES",2),u.setKnobValue("MIX",.25),u.setKnobValue("TIME",2.5))}catch(x){console.error("Patch load error",x)}};document.querySelectorAll(".preset-btn").forEach(i=>{i.addEventListener("click",a=>{const p=a.target.dataset.preset;s.state==="suspended"&&A(),o(p)})}),setTimeout(()=>{o("default")},100)},q=document.getElementById("start-btn"),J=document.getElementById("start-screen");q.addEventListener("click",async()=>{const m=I();m.state==="suspended"&&await m.resume(),J.style.opacity="0",setTimeout(()=>{J.style.display="none"},500),P()});
